<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/Bhimsonslogo.png">
    <title>Admin Dashboard - Bhimson's Agro Park</title>
    <meta name="description" content="Admin dashboard for Bhimson's Agro Park management.">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/admin.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="admin-sidebar-header">
                <h1 class="admin-logo">
                    BHIMSON'S
                    <span>Admin Panel</span>
                </h1>
            </div>
            
            <nav class="admin-nav">
                <div class="admin-nav-section">
                    <p class="admin-nav-title">Overview</p>
                    <a href="#" class="admin-nav-link active" data-section="overview">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Dashboard
                    </a>
                </div>
                
                <div class="admin-nav-section">
                    <p class="admin-nav-title">Management</p>
                    <a href="#" class="admin-nav-link" data-section="bookings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Bookings
                        <span class="badge" id="pendingBadge">0</span>
                    </a>
                    <a href="#" class="admin-nav-link" data-section="users">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Users
                    </a>
                    <a href="#" class="admin-nav-link" data-section="payments">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        Payments
                    </a>
                    <a href="#" class="admin-nav-link" data-section="passes">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 12 20 22 4 22 4 12"></polyline>
                            <rect x="2" y="7" width="20" height="5"></rect>
                            <line x1="12" y1="22" x2="12" y2="7"></line>
                            <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                            <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
                        </svg>
                        Passes
                    </a>
                </div>
            </nav>
            
            <div class="admin-sidebar-footer">
                <a href="#" class="admin-nav-link" id="adminLogout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Logout
                </a>
            </div>
        </aside>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Main Content -->
        <main class="admin-main">
            <!-- Header -->
            <header class="admin-header">
                <div class="admin-header-left">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="admin-search">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" placeholder="Search bookings, users..." id="globalSearch">
                    </div>
                </div>
                <div class="admin-header-right">
                    <div class="user-menu">
                        <button class="user-menu-toggle" id="adminUserMenu">
                            <span class="user-avatar" id="adminAvatar">A</span>
                            <span class="user-name" id="adminName">Admin</span>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Content -->
            <div class="admin-content">
                <!-- Overview Section -->
                <section id="overviewSection" class="admin-section">
                    
                    <!-- Welcome Summary Card -->
                    <div class="welcome-card" id="welcomeCard">
                        <div class="welcome-card-content">
                            <h2 class="welcome-title">Welcome back, <span id="welcomeName">Admin</span></h2>
                            <p class="welcome-subtitle" id="welcomeDate"></p>
                            <div class="welcome-summary" id="welcomeSummary">
                                <div class="welcome-summary-item">
                                    <span class="summary-number" id="summaryBookings">0</span>
                                    <span class="summary-label">bookings today</span>
                                </div>
                                <div class="welcome-summary-divider"></div>
                                <div class="welcome-summary-item">
                                    <span class="summary-number" id="summaryRevenue">₹0</span>
                                    <span class="summary-label">revenue this month</span>
                                </div>
                                <div class="welcome-summary-divider"></div>
                                <div class="welcome-summary-item">
                                    <span class="summary-number" id="summaryLogins">0</span>
                                    <span class="summary-label">visitors logged in today</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="admin-stats-grid" id="statsGrid">
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon blue">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                </svg>
                            </div>
                            <div class="admin-stat-info">
                                <h3 id="todayBookings">0</h3>
                                <p>Today's Bookings</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon green">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                            </div>
                            <div class="admin-stat-info">
                                <h3 id="totalRevenue">₹0</h3>
                                <p>Total Revenue</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon yellow">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                            </div>
                            <div class="admin-stat-info">
                                <h3 id="totalUsers">0</h3>
                                <p>Total Users</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon purple">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div class="admin-stat-info">
                                <h3 id="upcomingBookings">0</h3>
                                <p>Upcoming Bookings</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon teal">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                    <polyline points="10 17 15 12 10 7"></polyline>
                                    <line x1="15" y1="12" x2="3" y2="12"></line>
                                </svg>
                            </div>
                            <div class="admin-stat-info">
                                <h3 id="todayLogins">0</h3>
                                <p>Logins Today</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Two-column layout: Recent Bookings + Login Activity -->
                    <div class="admin-two-col">
                        <!-- Recent Bookings -->
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">Recent Bookings</h3>
                                <a href="#" class="btn-outline btn-sm" data-section="bookings">View All</a>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table" id="recentBookingsTable">
                                    <thead>
                                        <tr>
                                            <th>Booking #</th>
                                            <th>Customer</th>
                                            <th>Pass</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentBookingsBody">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: var(--space-8);">
                                                <div class="spinner"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Login Activity -->
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">Recent Visitor Activity</h3>
                                <a href="#" class="btn-outline btn-sm" data-section="users">View All Users</a>
                            </div>
                            <div class="login-activity-list" id="loginActivityList">
                                <div style="text-align: center; padding: var(--space-8);">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Bookings Section -->
                <section id="bookingsSection" class="admin-section" style="display: none;">
                    <h2 style="font-family: var(--font-display); font-size: var(--text-2xl); margin-bottom: var(--space-6);">BOOKINGS MANAGEMENT</h2>
                    
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3 class="admin-card-title">All Bookings</h3>
                            <div class="admin-card-actions">
                                <button class="btn-outline btn-sm" onclick="exportBookingsToCSV()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Export CSV
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filters -->
                        <div class="filters-bar">
                            <div class="filter-group">
                                <label class="filter-label">Status</label>
                                <select class="filter-select" id="filterStatus">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Date From</label>
                                <input type="date" class="filter-input" id="filterDateFrom">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Date To</label>
                                <input type="date" class="filter-input" id="filterDateTo">
                            </div>
                            <div class="filter-group" style="align-self: flex-end;">
                                <button class="btn-primary btn-sm" onclick="applyBookingFilters()">Apply</button>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Booking #</th>
                                        <th>Customer</th>
                                        <th>Pass</th>
                                        <th>Visit Date</th>
                                        <th>Guests</th>
                                        <th>Amount</th>
                                        <th>Payment</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allBookingsBody">
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: var(--space-8);">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Users Section -->
                <section id="usersSection" class="admin-section" style="display: none;">
                    <h2 style="font-family: var(--font-display); font-size: var(--text-2xl); margin-bottom: var(--space-6);">USER MANAGEMENT</h2>
                    
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3 class="admin-card-title">All Users</h3>
                            <button class="btn-outline btn-sm" onclick="exportUsersToCSV()">Export CSV</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Phone</th>
                                        <th>Total Bookings</th>
                                        <th>Registered</th>
                                        <th>Role</th>
                                    </tr>
                                </thead>
                                <tbody id="allUsersBody">
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: var(--space-8);">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Payments Section -->
                <section id="paymentsSection" class="admin-section" style="display: none;">
                    <h2 style="font-family: var(--font-display); font-size: var(--text-2xl); margin-bottom: var(--space-6);">PAYMENT RECORDS</h2>
                    
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3 class="admin-card-title">All Payments</h3>
                            <button class="btn-outline btn-sm" onclick="exportPaymentsToCSV()">Export CSV</button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Payment ID</th>
                                        <th>Booking #</th>
                                        <th>Customer</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="allPaymentsBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: var(--space-8);">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Passes Section -->
                <section id="passesSection" class="admin-section" style="display: none;">
                    <h2 style="font-family: var(--font-display); font-size: var(--text-2xl); margin-bottom: var(--space-6);">PASS MANAGEMENT</h2>
                    
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <h3 class="admin-card-title">All Passes</h3>
                        </div>
                        <div class="pass-management-grid" id="passesGrid">
                            <div style="text-align: center; padding: var(--space-8);">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Booking Detail Modal -->
    <div class="booking-detail-overlay" id="bookingDetailOverlay">
        <div class="booking-detail-modal">
            <div class="booking-detail-header">
                <h3 class="booking-detail-title">Booking Details</h3>
                <button class="booking-detail-close" id="closeBookingDetail">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="booking-detail-body" id="bookingDetailBody">
                <div style="text-align: center; padding: var(--space-8);">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Files -->
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/booking.js"></script>
    <script src="js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check admin access
            const admin = await isAdmin();
            if (!admin) {
                redirectTo('admin-login.html', 'Admin access required', 'error');
                return;
            }
            
            // Load admin profile
            const profile = await getUserProfile();
            if (profile) {
                document.getElementById('adminAvatar').textContent = profile.full_name?.charAt(0) || 'A';
                document.getElementById('adminName').textContent = profile.full_name || 'Admin';
                document.getElementById('welcomeName').textContent = profile.full_name?.split(' ')[0] || 'Admin';
            }
            
            // Set welcome date
            document.getElementById('welcomeDate').textContent = new Date().toLocaleDateString('en-IN', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            
            // Load dashboard data
            await loadDashboardData();
            
            // Navigation
            document.querySelectorAll('.admin-nav-link[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Close mobile sidebar
                    document.getElementById('adminSidebar').classList.remove('open');
                    document.getElementById('sidebarOverlay').classList.remove('show');
                });
            });
            
            // Mobile menu
            document.getElementById('mobileMenuToggle').addEventListener('click', function() {
                document.getElementById('adminSidebar').classList.toggle('open');
                document.getElementById('sidebarOverlay').classList.toggle('show');
            });
            
            document.getElementById('sidebarOverlay').addEventListener('click', function() {
                document.getElementById('adminSidebar').classList.remove('open');
                this.classList.remove('show');
            });
            
            // Logout
            document.getElementById('adminLogout').addEventListener('click', async function(e) {
                e.preventDefault();
                await logoutUser();
                window.location.href = 'admin-login.html';
            });
            
            // Booking detail modal close
            document.getElementById('closeBookingDetail').addEventListener('click', closeBookingDetailModal);
            document.getElementById('bookingDetailOverlay').addEventListener('click', function(e) {
                if (e.target === this) closeBookingDetailModal();
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeBookingDetailModal();
            });
        });
        
        async function loadDashboardData() {
            // Load stats, login stats, recent bookings, and login activity in parallel
            const [statsResult, loginStatsResult] = await Promise.all([
                fetchDashboardStats(),
                fetchLoginStats()
            ]);
            
            if (statsResult.success) {
                const s = statsResult.stats;
                document.getElementById('todayBookings').textContent = s.today_bookings || 0;
                document.getElementById('totalRevenue').textContent = '₹' + (s.total_revenue || 0).toLocaleString('en-IN');
                document.getElementById('totalUsers').textContent = s.total_users || 0;
                document.getElementById('upcomingBookings').textContent = s.upcoming_bookings || 0;
                
                // Welcome card summary
                document.getElementById('summaryBookings').textContent = s.today_bookings || 0;
                document.getElementById('summaryRevenue').textContent = '₹' + (s.total_revenue || 0).toLocaleString('en-IN');
            }
            
            if (loginStatsResult.success) {
                const ls = loginStatsResult.stats;
                document.getElementById('todayLogins').textContent = ls.today_unique_users || 0;
                document.getElementById('summaryLogins').textContent = ls.today_unique_users || 0;
            }
            
            // Load recent bookings and login activity
            await Promise.all([
                loadRecentBookings(),
                loadRecentLoginActivity()
            ]);
        }
        
        async function loadRecentBookings() {
            const result = await fetchAllBookings({ limit: 5 });
            const tbody = document.getElementById('recentBookingsBody');
            
            if (!result.success || !result.bookings?.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-text-muted);">No bookings yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.bookings.map(b => `
                <tr class="clickable-row" onclick="openBookingDetail('${b.id}')">
                    <td><strong>${b.booking_number}</strong></td>
                    <td>
                        <div class="table-user">
                            <div class="table-avatar">${b.user_name?.charAt(0) || 'U'}</div>
                            <div class="table-user-info">
                                <span class="table-user-name">${b.user_name || 'N/A'}</span>
                                <span class="table-user-email">${b.user_email || ''}</span>
                            </div>
                        </div>
                    </td>
                    <td>${b.pass_name}</td>
                    <td>${formatDate(b.visit_date, { weekday: undefined, year: undefined })}</td>
                    <td>₹${b.total_amount.toLocaleString('en-IN')}</td>
                    <td><span class="table-status ${b.status === 'confirmed' ? 'success' : b.status === 'pending' ? 'warning' : b.status === 'cancelled' ? 'danger' : 'info'}">${b.status}</span></td>
                </tr>
            `).join('');
        }
        
        async function loadRecentLoginActivity() {
            const result = await fetchRecentLogins(10);
            const container = document.getElementById('loginActivityList');
            
            if (!result.success || !result.logins?.length) {
                container.innerHTML = '<div class="login-activity-empty">No login activity yet. Visitor logins will appear here.</div>';
                return;
            }
            
            container.innerHTML = result.logins.map(login => `
                <div class="login-activity-item">
                    <div class="login-activity-avatar">${login.full_name?.charAt(0) || 'U'}</div>
                    <div class="login-activity-info">
                        <span class="login-activity-name">${login.full_name || 'Unknown User'}</span>
                        <span class="login-activity-email">${login.email || ''}</span>
                    </div>
                    <div class="login-activity-time">${getRelativeTime(login.login_at)}</div>
                </div>
            `).join('');
        }
        
        function showSection(section) {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.getElementById(section + 'Section').style.display = 'block';
            
            // Load section data
            if (section === 'bookings') loadAllBookingsData();
            if (section === 'users') loadAllUsersData();
            if (section === 'payments') loadAllPaymentsData();
            if (section === 'passes') loadAllPassesData();
        }
        
        async function loadAllBookingsData() {
            const result = await fetchAllBookings();
            const tbody = document.getElementById('allBookingsBody');
            
            if (!result.success || !result.bookings?.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No bookings found</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.bookings.map(b => `
                <tr class="clickable-row" onclick="openBookingDetail('${b.id}')">
                    <td><strong>${b.booking_number}</strong></td>
                    <td>
                        <div class="table-user">
                            <div class="table-avatar">${b.user_name?.charAt(0) || 'U'}</div>
                            <div class="table-user-info">
                                <span class="table-user-name">${b.user_name}</span>
                                <span class="table-user-email">${b.user_email}</span>
                            </div>
                        </div>
                    </td>
                    <td>${b.pass_name}</td>
                    <td>${formatDate(b.visit_date, { weekday: undefined })}</td>
                    <td>${b.total_guests}</td>
                    <td>₹${b.total_amount.toLocaleString('en-IN')}</td>
                    <td><span class="table-status ${b.payment_status === 'successful' ? 'success' : 'warning'}">${b.payment_status || 'pending'}</span></td>
                    <td><span class="table-status ${b.status === 'confirmed' ? 'success' : b.status === 'pending' ? 'warning' : 'danger'}">${b.status}</span></td>
                    <td>
                        <div class="table-actions">
                            ${b.status === 'confirmed' ? `<button class="table-action-btn" onclick="event.stopPropagation(); markCompleted('${b.id}')" title="Mark Completed">✓</button>` : ''}
                            ${b.status === 'pending' || b.status === 'confirmed' ? `<button class="table-action-btn" onclick="event.stopPropagation(); cancelAdminBooking('${b.id}')" title="Cancel">✕</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        async function loadAllUsersData() {
            const result = await fetchAllUsers();
            const tbody = document.getElementById('allUsersBody');
            
            if (!result.success || !result.users?.length) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.users.map(u => `
                <tr>
                    <td>
                        <div class="table-user">
                            <div class="table-avatar">${u.full_name?.charAt(0) || 'U'}</div>
                            <div class="table-user-info">
                                <span class="table-user-name">${u.full_name}</span>
                                <span class="table-user-email">${u.email}</span>
                            </div>
                        </div>
                    </td>
                    <td>${u.phone || 'N/A'}</td>
                    <td>${u.total_bookings}</td>
                    <td>${formatDate(u.created_at, { weekday: undefined })}</td>
                    <td><span class="table-status ${u.is_admin ? 'info' : 'success'}">${u.is_admin ? 'Admin' : 'User'}</span></td>
                </tr>
            `).join('');
        }
        
        async function loadAllPaymentsData() {
            const result = await fetchAllPayments();
            const tbody = document.getElementById('allPaymentsBody');
            
            if (!result.success || !result.payments?.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No payments found</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.payments.map(p => `
                <tr>
                    <td>${p.razorpay_payment_id || p.id.slice(0, 8)}</td>
                    <td>${p.bookings?.booking_number || 'N/A'}</td>
                    <td>${p.bookings?.profiles?.full_name || 'N/A'}</td>
                    <td>₹${p.amount.toLocaleString('en-IN')}</td>
                    <td>${p.payment_method || 'razorpay'}</td>
                    <td><span class="table-status ${p.status === 'successful' ? 'success' : p.status === 'failed' ? 'danger' : 'warning'}">${p.status}</span></td>
                    <td>${formatDateTime(p.created_at)}</td>
                </tr>
            `).join('');
        }
        
        async function loadAllPassesData() {
            const result = await fetchAllPasses();
            const container = document.getElementById('passesGrid');
            
            if (!result.success || !result.passes?.length) {
                container.innerHTML = '<p style="text-align: center;">No passes found</p>';
                return;
            }
            
            container.innerHTML = result.passes.map(p => `
                <div class="pass-manage-card">
                    <div class="pass-manage-header">
                        <h3 class="pass-manage-title">${p.name}</h3>
                        <span class="pass-manage-status ${p.is_active ? 'active' : 'inactive'}">${p.is_active ? 'Active' : 'Inactive'}</span>
                    </div>
                    <p style="font-size: var(--text-sm); color: var(--color-text-muted); margin-bottom: var(--space-4);">${p.description}</p>
                    <div class="pass-manage-price">
                        <span class="current">₹${p.price.toLocaleString('en-IN')}</span>
                        ${p.original_price ? `<span class="original">₹${p.original_price.toLocaleString('en-IN')}</span>` : ''}
                    </div>
                    <div class="pass-manage-actions">
                        <label class="toggle-switch">
                            <input type="checkbox" ${p.is_active ? 'checked' : ''} onchange="togglePass('${p.id}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            `).join('');
        }
        
        async function applyBookingFilters() {
            const filters = {
                status: document.getElementById('filterStatus').value,
                date_from: document.getElementById('filterDateFrom').value,
                date_to: document.getElementById('filterDateTo').value
            };
            
            const result = await fetchAllBookings(filters);
            const tbody = document.getElementById('allBookingsBody');
            
            if (!result.success || !result.bookings?.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No bookings match your filters</td></tr>';
                return;
            }
            
            // Re-render with filtered data
            tbody.innerHTML = result.bookings.map(b => `
                <tr class="clickable-row" onclick="openBookingDetail('${b.id}')">
                    <td><strong>${b.booking_number}</strong></td>
                    <td>
                        <div class="table-user">
                            <div class="table-avatar">${b.user_name?.charAt(0) || 'U'}</div>
                            <div class="table-user-info">
                                <span class="table-user-name">${b.user_name}</span>
                                <span class="table-user-email">${b.user_email}</span>
                            </div>
                        </div>
                    </td>
                    <td>${b.pass_name}</td>
                    <td>${formatDate(b.visit_date, { weekday: undefined })}</td>
                    <td>${b.total_guests}</td>
                    <td>₹${b.total_amount.toLocaleString('en-IN')}</td>
                    <td><span class="table-status ${b.payment_status === 'successful' ? 'success' : 'warning'}">${b.payment_status || 'pending'}</span></td>
                    <td><span class="table-status ${b.status === 'confirmed' ? 'success' : b.status === 'pending' ? 'warning' : 'danger'}">${b.status}</span></td>
                    <td>
                        <div class="table-actions">
                            ${b.status === 'confirmed' ? `<button class="table-action-btn" onclick="event.stopPropagation(); markCompleted('${b.id}')" title="Mark Completed">✓</button>` : ''}
                            ${b.status === 'pending' || b.status === 'confirmed' ? `<button class="table-action-btn" onclick="event.stopPropagation(); cancelAdminBooking('${b.id}')" title="Cancel">✕</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        async function markCompleted(bookingId) {
            const result = await updateBookingStatus(bookingId, 'completed');
            if (result.success) {
                showToast('Booking marked as completed', 'success');
                loadAllBookingsData();
            } else {
                showToast(result.error, 'error');
            }
        }
        
        async function cancelAdminBooking(bookingId) {
            const confirmed = await showConfirmModal({
                title: 'Cancel Booking',
                message: 'Are you sure you want to cancel this booking?',
                confirmText: 'Yes, Cancel',
                isDangerous: true
            });
            
            if (confirmed) {
                const result = await updateBookingStatus(bookingId, 'cancelled', 'Cancelled by admin');
                if (result.success) {
                    showToast('Booking cancelled', 'success');
                    loadAllBookingsData();
                } else {
                    showToast(result.error, 'error');
                }
            }
        }
        
        async function togglePass(passId, isActive) {
            const result = await togglePassStatus(passId, isActive);
            if (result.success) {
                showToast(`Pass ${isActive ? 'activated' : 'deactivated'}`, 'success');
            } else {
                showToast(result.error, 'error');
                loadAllPassesData(); // Revert
            }
        }
        
        // =====================================================
        // BOOKING DETAIL MODAL
        // =====================================================
        
        async function openBookingDetail(bookingId) {
            const overlay = document.getElementById('bookingDetailOverlay');
            const body = document.getElementById('bookingDetailBody');
            
            overlay.classList.add('show');
            body.innerHTML = '<div style="text-align: center; padding: var(--space-8);"><div class="spinner"></div><p style="margin-top: var(--space-4); color: var(--color-text-muted);">Loading booking details...</p></div>';
            
            const result = await fetchBookingDetail(bookingId);
            
            if (!result.success) {
                body.innerHTML = `<div style="text-align: center; padding: var(--space-8); color: var(--color-text-muted);">Failed to load booking details. ${result.error || ''}</div>`;
                return;
            }
            
            const b = result.booking;
            const p = result.payment;
            const logs = result.logs;
            
            const statusClass = b.status === 'confirmed' ? 'success' : b.status === 'pending' ? 'warning' : b.status === 'cancelled' ? 'danger' : 'info';
            const paymentStatusClass = p?.status === 'successful' ? 'success' : p?.status === 'failed' ? 'danger' : 'warning';
            
            body.innerHTML = `
                <div class="detail-section">
                    <div class="detail-row-header">
                        <h4>Booking #${b.booking_number}</h4>
                        <span class="table-status ${statusClass}">${b.status}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4 class="detail-section-title">Customer Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Name</span>
                            <span class="detail-value">${b.profiles?.full_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email</span>
                            <span class="detail-value">${b.profiles?.email || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone</span>
                            <span class="detail-value">${b.profiles?.phone || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4 class="detail-section-title">Booking Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Pass Type</span>
                            <span class="detail-value">${b.passes?.name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Visit Date</span>
                            <span class="detail-value">${formatDate(b.visit_date)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Adults</span>
                            <span class="detail-value">${b.num_adults}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Children</span>
                            <span class="detail-value">${b.num_children || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Total Guests</span>
                            <span class="detail-value">${b.total_guests}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Booked On</span>
                            <span class="detail-value">${formatDateTime(b.created_at)}</span>
                        </div>
                    </div>
                    ${b.special_requests ? `
                    <div class="detail-item" style="margin-top: var(--space-4);">
                        <span class="detail-label">Special Requests</span>
                        <span class="detail-value">${sanitizeHTML(b.special_requests)}</span>
                    </div>` : ''}
                    ${b.dietary_preferences ? `
                    <div class="detail-item" style="margin-top: var(--space-2);">
                        <span class="detail-label">Dietary Preferences</span>
                        <span class="detail-value">${sanitizeHTML(b.dietary_preferences)}</span>
                    </div>` : ''}
                </div>
                
                <div class="detail-section">
                    <h4 class="detail-section-title">Payment Details</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Base Amount</span>
                            <span class="detail-value">₹${(b.base_amount || 0).toLocaleString('en-IN')}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Tax</span>
                            <span class="detail-value">₹${(b.tax_amount || 0).toLocaleString('en-IN')}</span>
                        </div>
                        <div class="detail-item detail-item-highlight">
                            <span class="detail-label">Total Amount</span>
                            <span class="detail-value detail-value-large">₹${(b.total_amount || 0).toLocaleString('en-IN')}</span>
                        </div>
                        ${p ? `
                        <div class="detail-item">
                            <span class="detail-label">Payment Status</span>
                            <span class="table-status ${paymentStatusClass}">${p.status}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Razorpay ID</span>
                            <span class="detail-value">${p.razorpay_payment_id || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Payment Method</span>
                            <span class="detail-value">${p.payment_method || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Payment Date</span>
                            <span class="detail-value">${formatDateTime(p.created_at)}</span>
                        </div>
                        ` : '<div class="detail-item"><span class="detail-label">Payment</span><span class="detail-value" style="color: var(--color-text-muted);">No payment recorded</span></div>'}
                    </div>
                </div>
                
                ${b.qr_code_url ? `
                <div class="detail-section">
                    <h4 class="detail-section-title">QR Code</h4>
                    <div class="detail-qr">
                        <img src="${b.qr_code_url}" alt="Booking QR Code" class="detail-qr-img">
                    </div>
                </div>` : ''}
                
                ${logs && logs.length > 0 ? `
                <div class="detail-section">
                    <h4 class="detail-section-title">Activity Log</h4>
                    <div class="detail-timeline">
                        ${logs.map(log => `
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <span class="timeline-action">${log.action.replace(/_/g, ' ')}</span>
                                    ${log.notes ? `<span class="timeline-notes">${sanitizeHTML(log.notes)}</span>` : ''}
                                    <span class="timeline-time">${getRelativeTime(log.created_at)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}
                
                <div class="detail-actions">
                    ${b.status === 'confirmed' ? `<button class="btn-primary btn-sm" onclick="markCompleted('${b.id}'); closeBookingDetailModal();">Mark Completed</button>` : ''}
                    ${b.status === 'pending' || b.status === 'confirmed' ? `<button class="btn-outline btn-sm" style="color: #DC3545; border-color: #DC3545;" onclick="cancelAdminBooking('${b.id}'); closeBookingDetailModal();">Cancel Booking</button>` : ''}
                </div>
            `;
        }
        
        function closeBookingDetailModal() {
            document.getElementById('bookingDetailOverlay').classList.remove('show');
        }
    </script>
</body>
</html>
